import{u as Q,j as e,s as j,z as p}from"./admin-Cp27DgWA.js";import{d as X,u as ee,c as te,r as g}from"./router-C-JlvvJt.js";import{o as F,i as se,p as V,q as ae,r as M,s as ne,b as K,e as oe,m as re,n as le,t as ie,u as de,v as ce}from"./index-Dfj_MLPr.js";import{A as ge,O as me,C as ue,a as he,T as xe}from"./AgentDetailsView-CKaNxhiH.js";import"./vendor-DJG_os-6.js";import"./icons-Cy3jFTXJ.js";const Ne=()=>{const S=X(),v=ee(),u=te(),{theme:be,currentTheme:i}=Q(),t=S.clientId||S.id;if(console.log("ğŸ” ClientId from URL params:",t),!t){const a=u.pathname.split("/"),n=a[a.length-1];console.log("ğŸ” Path segments:",a),console.log("ğŸ” Possible clientId from path:",n)}const[s,N]=g.useState(u.state?.client||null),[O,x]=g.useState(!u.state?.client),[T,L]=g.useState(null),[z,U]=g.useState("details"),[$,_]=g.useState(null),[I,C]=g.useState(!1),[m,P]=g.useState(null),[A,h]=g.useState(null),b=g.useMemo(()=>{const a=m&&typeof m=="object"&&Object.keys(m).length>0,n=s?.userData?.isOnboarded||s?.isOnboarded,r=a||n||!1;return console.log("ğŸ¯ isOnboarded calculation:",{hasClient:!!s,userData_isOnboarded:s?.userData?.isOnboarded,client_isOnboarded:s?.isOnboarded,hasOnboardingData:a,onboardingDataKeys:m?Object.keys(m):[],finalValue:r}),r},[s?.userData?.isOnboarded,s?.isOnboarded,m]);g.useEffect(()=>{if(console.log("ğŸ¯ ClientDetailsPage mounted with clientId:",t),!t){console.error("âŒ Critical Error: No clientId found in URL params"),h("Invalid URL - Client ID is missing"),x(!1);return}if(typeof t!="string"){console.error("âŒ Critical Error: ClientId is not a string:",typeof t,t),h("Invalid Client ID format"),x(!1);return}if(t.length<3){console.error("âŒ Critical Error: ClientId too short:",t,"Length:",t.length),h("Invalid Client ID - ID too short"),x(!1);return}if(!/^[a-zA-Z0-9_-]+$/.test(t)){console.error("âŒ Critical Error: ClientId contains invalid characters:",t),h("Invalid Client ID - Contains invalid characters"),x(!1);return}console.log("âœ… ClientId validation passed:",t)},[t]),g.useEffect(()=>{const a=async()=>{if(console.log("ğŸ”„ fetchOnboardingData triggered - client exists:",!!s),console.log("ğŸ”„ Client object:",s),!s){console.log("â³ No client data available yet, skipping onboarding fetch");return}if(I){console.log("â³ API calls already in progress, skipping onboarding fetch");return}const n={userData_id:s?.userData?._id,client_id:s?._id,userData_id_alt:s?.userData?.id,client_id_alt:s?.id,email:s?.email,userData_email:s?.userData?.email};console.log("ğŸ” UserId extraction options:",n);const r=t;if(console.log("ğŸ” Final extracted userId:",r),!r)if(console.warn("âš ï¸ No user ID found for fetching onboarding data"),console.warn("âš ï¸ Client structure:",{hasUserData:!!s.userData,hasId:!!s._id,hasAltId:!!s.id,clientKeys:Object.keys(s)}),t)console.log("ğŸ”„ Using clientId as fallback for onboarding fetch:",t);else return;const c=r||t;if(typeof c!="string"||c.length<3){console.warn("âš ï¸ Invalid user ID format:",c),h("Invalid user ID format");return}try{console.log("ğŸš€ Starting API call for onboarding data - userId:",c),C(!0),h(null),console.log("ğŸ” Fetching onboarding data for user ID:",c);const l=await j.getOnboardingByUserId(c);console.log("âœ… Onboarding data fetched:",l);let o=null;l?.success&&l?.data?.onboarding?(o=l.data.onboarding,console.log("ğŸ“Š Extracted data from response.data.onboarding:",o)):l?.data?.onboarding?(o=l.data.onboarding,console.log("ğŸ“Š Extracted data from response.data.onboarding (no success):",o)):l?.onboarding?(o=l.onboarding,console.log("ğŸ“Š Extracted data from response.onboarding:",o)):l?.success&&l?.data?(o=l.data,console.log("ğŸ“Š Extracted data from response.data (direct):",o)):l?.data?(o=l.data,console.log("ğŸ“Š Extracted data from response.data (fallback):",o)):(o=l,console.log("ğŸ“Š Using entire response as data:",o)),console.log("âœ… Final onboarding data to set:",o),console.log("ğŸ“‹ Data type:",typeof o,"Is object:",typeof o=="object"),console.log("ğŸ“‹ Data keys:",o&&typeof o=="object"?Object.keys(o):"Not an object"),console.log("ğŸ“‹ Has company_basics:",!!o?.company_basics),console.log("ğŸ“‹ Has ai_employees:",!!o?.ai_employees),P(o)}catch(l){console.error("âŒ Error fetching onboarding data:",l),h(l.message||"Failed to load onboarding data");const o=s?.onboardingDetails?.onboarding||s?.userData?.onboarding||s?.onboarding||{};o&&Object.keys(o).length>0&&(console.log("ğŸ“‹ Using fallback onboarding data from client prop"),P(o),h(null))}finally{C(!1)}};s&&(console.log("ğŸ¯ useEffect triggered for onboarding data - clientId:",s?._id||s?.id),a())},[s,t]);const f=g.useMemo(()=>{const a=[{id:"onboarding",label:"Onboarding Data",icon:F},{id:"details",label:"Client Details",icon:se},{id:"employees",label:"AI Employees",icon:V},{id:"transactions",label:"Transactions",icon:ae}],n=b?a:a.filter(r=>r.id!=="onboarding");return console.log("ğŸ” Tabs calculation:",{isOnboarded:b,allTabsCount:a.length,finalTabsCount:n.length,finalTabIds:n.map(r=>r.id),onboardingTabIncluded:n.some(r=>r.id==="onboarding")}),n},[b]),E=g.useCallback(()=>{const n=new URLSearchParams(u.search).get("tab");if(console.log("ğŸ¯ getInitialTab - tabFromUrl:",n,"isOnboarded:",b),n&&f.some(c=>c.id===n))return console.log("âœ… Using tab from URL:",n),n;const r=b?"onboarding":"details";return console.log("âœ… Using default tab:",r),r},[u.search,f,b]),[d,w]=g.useState(E);g.useEffect(()=>{const a=E();console.log("ğŸ¯ Tab update check - currentTab:",a,"activeTab:",d,"isOnboarded:",b),d==="onboarding"&&!b?(console.log("ğŸ”„ Switching from onboarding to details (not onboarded)"),w("details")):f.some(n=>n.id===d)||(console.log("ğŸ”„ Switching to valid tab:",a),w(a))},[b,f,E,d]),g.useEffect(()=>{if(new URLSearchParams(u.search).get("tab")!==d){const r=new URLSearchParams(u.search);r.set("tab",d);const c=`${u.pathname}?${r.toString()}`;window.location.href!==window.location.origin+c&&window.history.replaceState(u.state,"",c)}},[d,u.pathname,u.search,u.state]),g.useEffect(()=>{const a=async()=>{if(console.log("ğŸ”„ fetchClientDetails triggered"),console.log("ğŸ” Current clientId:",t),console.log("ğŸ” ClientId type:",typeof t),console.log("ğŸ” ClientId length:",t?.length),console.log("ğŸ” Location state exists:",!!u.state?.client),u.state?.client){console.log("âœ… Using client data from navigation state:",u.state.client),N(u.state.client),x(!1);return}if(!t){console.error("âŒ CRITICAL: No clientId provided - cannot fetch client data"),h("Client ID is required but missing from URL"),x(!1);return}if(typeof t!="string"){console.error("âŒ CRITICAL: ClientId is not a string:",typeof t,t),h("Invalid Client ID type"),x(!1);return}if(t.length<3){console.error("âŒ CRITICAL: ClientId too short for valid ID:",t,"Length:",t.length),h("Invalid Client ID format"),x(!1);return}if(I){console.log("â³ API calls already in progress, skipping client fetch");return}try{console.log("ğŸš€ Starting API call for client details"),console.log("ğŸ“¡ API Call - ClientId being sent:",t),console.log("ğŸ“¡ API Call - ClientId length:",t.length),console.log("ğŸ“¡ API Call - ClientId type:",typeof t),x(!0),C(!0),h(null);let n;try{console.log("ğŸ”„ Attempting getAgentsById with clientId:",t);const r=await j.getAgentsById(t);console.log("âœ… getAgentsById SUCCESS - Response:",r),n={success:!0,data:r}}catch(r){console.log("âŒ getAgentsById FAILED for clientId:",t,"Error:",r.message);try{console.log("ğŸ”„ Attempting direct /users endpoint with clientId:",t);const c=await j.get(`/v1/users/${t}`);console.log("âœ… Direct /users endpoint SUCCESS - Response:",c),n=c}catch(c){console.log("âŒ Direct /users endpoint FAILED for clientId:",t,"Error:",c.message),console.log("ğŸ”„ Attempting getAllUsers fallback and filtering for clientId:",t);const l=await j.getAllUsers();console.log("ğŸ“Š getAllUsers response structure:",{hasData:!!l?.data,hasDataData:!!l?.data?.data,isArray:Array.isArray(l),dataIsArray:Array.isArray(l?.data),dataDataIsArray:Array.isArray(l?.data?.data)});let o=[];if(l?.data?.data)o=l.data.data;else if(l?.data&&Array.isArray(l.data))o=l.data;else if(Array.isArray(l))o=l;else throw console.error("âŒ Invalid users response structure:",l),new Error("Unable to fetch client data. Invalid response structure from API.");if(!Array.isArray(o))throw console.error("âŒ Users data is not an array:",typeof o,o),new Error("Users data is not in expected array format");console.log(`ğŸ” Searching for clientId "${t}" in ${o.length} users`);const R=o.find(y=>{const B=[y._id===t,y.id===t,y.userData?._id===t,y.userData?.id===t];return B.some(J=>J)?(console.log("âœ… User match found:",{user_id:y._id||y.id,userData_id:y.userData?._id||y.userData?.id,searchingFor:t,matchedBy:B}),!0):!1});if(R)console.log("âœ… Client found in users list:",R),n={success:!0,data:R};else throw console.error(`âŒ Client with ID "${t}" not found in ${o.length} users`),new Error(`Client not found: No client with ID "${t}" exists in the system`)}}n?.success&&n?.data?(console.log("âœ… Final client data to be set:",n.data),N(n.data),h(null)):(console.error("âŒ Invalid response structure:",n),h("Failed to load client data - Invalid API response"))}catch(n){if(console.error("âŒ Complete API failure for clientId:",t,"Error:",n),n.response?.status===404)console.log("ğŸ”„ 404 Error - Navigating back to clients list"),p.error("Client not found"),v("/dashboard/clients");else{let r=`Failed to load client details for ID: ${t}`;n.response?.status===403?r="Access denied - You don't have permission to view this client":n.code==="NETWORK_ERROR"||!navigator.onLine?r="Network error. Please check your connection and try again.":n.message&&(r=n.message),h(r),p.error(r)}}finally{x(!1),C(!1)}};t&&typeof t=="string"&&t.length>=3?(console.log("ğŸ¯ Starting fetchClientDetails with validated clientId:",t),a()):(console.error("âŒ Cannot fetch client details - invalid clientId:",t),h("Invalid Client ID in URL"),x(!1))},[t,v]),g.useEffect(()=>{if(s){const a=s?.userData?.fullName||s?.company_basics?.name||"Client",n=f.find(r=>r.id===d)?.label||"Details";document.title=`${a} - ${n} | ShivAI Admin`}else document.title="Client Details | ShivAI Admin";return()=>{document.title="ShivAI Admin"}},[s,d]);const k=()=>{window.history.length>1?v(-1):v("/dashboard/clients")},H=a=>{p("Edit functionality coming soon",{icon:"â„¹ï¸",duration:3e3})},Y=async a=>{if(window.confirm(`Are you sure you want to delete ${a?.userData?.fullName||"this client"}?`))try{await j.deleteClient(a?._id),p.success("Client deleted successfully"),v("/dashboard/clients")}catch(n){console.error("Error deleting client:",n),p.error("Failed to delete client")}},q=async a=>{console.log(a,"jj");try{if((await j.approveClient(m?._id))?.message==="Onboarding approved successfully"){p.success("Client approved successfully");const r={...a,onboardingStatus:"approved",userData:{...a.userData,isOnboarded:!0}};N(r);try{const c=await j.getAgentsById(t);c&&N(c)}catch(c){console.warn("Could not refresh client data after approval:",c)}}}catch(n){console.error("Error approving client:",n),p.error("Failed to approve client")}},W=async a=>{try{await j.rejectClient(m?._id),p.success("Client rejected successfully"),v("/dashboard/clients")}catch(n){console.error("Error rejecting client:",n),p.error("Failed to reject client")}},Z=a=>{console.log("View agent:",a),_(d),L(a),U("agentView")},G=()=>{L(null),U("details"),$&&(w($),_(null))};if(console.log("ğŸ” ClientDetailsPage - isOnboarded:",b),console.log("ğŸ” ClientDetailsPage - Tabs to display:",f.map(a=>a.id)),console.log("ğŸ” ClientDetailsPage - Current active tab:",d),O)return e.jsx("div",{className:"min-h-screen flex items-center justify-center",children:e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"})});if(!s&&!O&&A)return e.jsx("div",{className:"min-h-screen flex items-center justify-center",children:e.jsxs("div",{className:"text-center",children:[e.jsx(M,{className:"w-16 h-16 mx-auto mb-4 text-red-500"}),e.jsx("h2",{className:"text-2xl font-bold text-gray-900 mb-2",children:A.includes("Network")?"Connection Error":"Error Loading Client"}),e.jsx("p",{className:"text-gray-600 mb-4",children:A}),e.jsxs("div",{className:"flex gap-2 justify-center",children:[e.jsx("button",{onClick:()=>window.location.reload(),className:"px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg transition-colors",children:"Try Again"}),e.jsx("button",{onClick:k,className:"px-4 py-2 bg-gray-500 hover:bg-gray-600 text-white rounded-lg transition-colors",children:"Back to Clients"})]})]})});if(!s)return e.jsx("div",{className:"min-h-screen flex items-center justify-center",children:e.jsxs("div",{className:"text-center",children:[e.jsx(M,{className:"w-16 h-16 mx-auto mb-4 text-red-500"}),e.jsx("h2",{className:"text-2xl font-bold text-gray-900 mb-2",children:"Client Not Found"}),e.jsx("button",{onClick:k,className:"px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg transition-colors",children:"Back to Clients"})]})});if(z==="agentView"&&T)return e.jsx(ge,{agent:T,onBack:G,currentTheme:i});const D={totalAIEmployees:s?.ai_employees?.length||0,liveAIEmployees:s?.ai_employees?.filter(a=>a.status==="active")?.length||0,totalCalls:0,totalRevenue:0,isActive:s?.isApproved||!1};return e.jsxs("div",{className:"space-y-3",children:[e.jsx("div",{className:`${i.cardBg} border ${i.border} rounded-lg p-3 md:p-4`,children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center space-x-2 md:space-x-3",children:[e.jsx("button",{onClick:k,className:"p-1.5 md:p-2 hover:bg-gray-100 rounded-lg transition-colors",children:e.jsx(ne,{className:"w-4 h-4 md:w-5 md:h-5 text-gray-600"})}),e.jsxs("div",{children:[e.jsx("h1",{className:`text-lg md:text-xl font-semibold ${i.text}`,children:s?.fullName||s?.company_basics?.name||"Client Details"}),e.jsx("p",{className:`text-xs md:text-sm ${i.textSecondary}`,children:s?.email||s?.company_basics?.company_email||""})]})]}),e.jsxs("div",{className:"flex items-center space-x-1 md:space-x-2",children:[(s?.userData?.isOnboarded||s?.isOnboarded)&&s?.onboardingStatus!=="approved"&&e.jsxs(e.Fragment,{children:[e.jsx("button",{onClick:()=>q(s),className:"p-1.5 md:p-2 hover:bg-green-50 rounded-lg transition-colors",title:"Accept Client",children:e.jsx(K,{className:"w-3.5 h-3.5 md:w-4 md:h-4 text-green-600"})}),e.jsx("button",{onClick:()=>W(),className:"p-1.5 md:p-2 hover:bg-red-50 rounded-lg transition-colors",title:"Reject Client",children:e.jsx(oe,{className:"w-3.5 h-3.5 md:w-4 md:h-4 text-red-600"})})]}),s?.onboardingStatus==="approved"&&e.jsxs("div",{className:"flex items-center space-x-1 px-2 py-1 md:px-3 md:py-1.5 bg-green-100 text-green-700 rounded-lg text-xs md:text-sm font-medium",children:[e.jsx(K,{className:"w-3 h-3 md:w-4 md:h-4"}),e.jsx("span",{children:"Approved"})]}),e.jsx("button",{onClick:()=>H(),className:"p-1.5 md:p-2 hover:bg-gray-100 rounded-lg transition-colors",title:"Edit Client",children:e.jsx(re,{className:"w-3.5 h-3.5 md:w-4 md:h-4 text-gray-600"})}),e.jsx("button",{onClick:()=>Y(s),className:"p-1.5 md:p-2 hover:bg-red-50 rounded-lg transition-colors",title:"Delete Client",children:e.jsx(le,{className:"w-3.5 h-3.5 md:w-4 md:h-4 text-red-600"})})]})]})}),e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-2 md:gap-4",children:[e.jsx("div",{className:`${i.cardBg} border ${i.border} rounded-lg p-3 md:p-4`,children:e.jsxs("div",{className:"flex items-start space-x-2 md:space-x-3",children:[e.jsx("div",{className:"p-1.5 md:p-2 bg-gray-50 rounded-lg",children:e.jsx(V,{className:"w-4 h-4 md:w-5 md:h-5 text-gray-900"})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("p",{className:`text-lg md:text-xl font-bold ${i.text} leading-none`,children:D.totalAIEmployees}),e.jsx("p",{className:`text-xs md:text-sm ${i.textSecondary} truncate`,children:"AI Employees"})]})]})}),e.jsx("div",{className:`${i.cardBg} border ${i.border} rounded-lg p-3 md:p-4`,children:e.jsxs("div",{className:"flex items-start space-x-2 md:space-x-3",children:[e.jsx("div",{className:"p-1.5 md:p-2 bg-gray-50 rounded-lg",children:e.jsx(ie,{className:"w-4 h-4 md:w-5 md:h-5 text-gray-900"})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("p",{className:`text-lg md:text-xl font-bold ${i.text} leading-none`,children:D.liveAIEmployees}),e.jsx("p",{className:`text-xs md:text-sm ${i.textSecondary} truncate`,children:"Active Now"})]})]})}),e.jsx("div",{className:`${i.cardBg} border ${i.border} rounded-lg p-3 md:p-4`,children:e.jsxs("div",{className:"flex items-start space-x-2 md:space-x-3",children:[e.jsx("div",{className:"p-1.5 md:p-2 bg-gray-50 rounded-lg",children:e.jsx(de,{className:"w-4 h-4 md:w-5 md:h-5 text-gray-900"})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("p",{className:`text-lg md:text-xl font-bold ${i.text} leading-none`,children:D.totalCalls}),e.jsx("p",{className:`text-xs md:text-sm ${i.textSecondary} truncate`,children:"Total Calls"})]})]})}),e.jsx("div",{className:`${i.cardBg} border ${i.border} rounded-lg p-3 md:p-4`,children:e.jsxs("div",{className:"flex items-start space-x-2 md:space-x-3",children:[e.jsx("div",{className:"p-1.5 md:p-2 bg-gray-50 rounded-lg",children:e.jsx(ce,{className:"w-4 h-4 md:w-5 md:h-5 text-gray-900"})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("p",{className:`text-lg md:text-xl font-bold ${i.text} leading-none`,children:["$",D.totalRevenue.toLocaleString()]}),e.jsx("p",{className:`text-xs md:text-sm ${i.textSecondary} truncate`,children:"Revenue"})]})]})})]}),e.jsxs("div",{className:`${i.cardBg} border ${i.border} rounded-lg`,children:[e.jsx("div",{className:"border-b border-gray-200 px-2 md:px-4",children:e.jsx("div",{className:"flex  space-x-2 md:space-x-4 overflow-x-auto scrollbar-hide",children:f.map(a=>{const n=a.icon;return e.jsxs("button",{onClick:()=>w(a.id),className:`flex items-center space-x-1 md:space-x-2 px-2 md:px-4 py-3 md:py-3 text-[13px] lg:text-[16px] md:text-sm font-medium border-b-2 whitespace-nowrap ${d===a.id?"border-blue-500 text-blue-600":"border-transparent text-gray-600 hover:text-gray-900"}`,children:[e.jsx(n,{className:"w-4 h-4 md:w-4 md:h-4"}),e.jsx("span",{children:a.label})]},a.id)})})}),e.jsxs("div",{className:"p-3 md:p-6",children:[e.jsxs("div",{className:d==="onboarding"?"block":"hidden",children:[console.log("ğŸ¯ OnboardingDataTab rendering:",{activeTab:d,isOnboardingTabActive:d==="onboarding",hasClient:!!s,hasOnboardingData:!!m,onboardingDataKeys:m?Object.keys(m):[],onboardingDataStructure:m,isOnboarded:b,apiCallsInProgress:I,tabsAvailable:f.map(a=>a.id)}),d==="onboarding"&&I?e.jsxs("div",{className:"flex items-center justify-center py-8",children:[e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"}),e.jsx("span",{className:"ml-3 text-gray-600",children:"Loading onboarding data..."})]}):d==="onboarding"&&!m?e.jsxs("div",{className:"text-center py-8",children:[e.jsxs("div",{className:"text-gray-500 mb-4",children:[e.jsx(F,{className:"w-16 h-16 mx-auto mb-4 text-gray-400"}),e.jsx("p",{className:"text-lg font-medium mb-2",children:"No Onboarding Data Available"}),e.jsx("p",{className:"text-sm",children:"This client hasn't completed the onboarding process yet."})]}),e.jsx("button",{onClick:()=>window.location.reload(),className:"px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg transition-colors text-sm",children:"Refresh Data"})]}):d==="onboarding"&&m?e.jsxs(e.Fragment,{children:[console.log("ğŸš€ Rendering OnboardingDataTab with data:",m),e.jsx(me,{client:s,onboardingData:m,currentTheme:i})]}):d==="onboarding"&&e.jsxs("div",{className:"text-center py-8 text-gray-500",children:[e.jsx("p",{children:"Onboarding tab not active or data loading..."}),e.jsxs("p",{className:"text-xs mt-2",children:["Active tab: ",d]}),e.jsxs("p",{className:"text-xs",children:["Has data: ",m?"Yes":"No"]}),e.jsxs("p",{className:"text-xs",children:["API in progress: ",I?"Yes":"No"]})]})]}),e.jsx("div",{className:d==="details"?"block":"hidden",children:e.jsx(ue,{client:s,currentTheme:i})}),e.jsx("div",{className:d==="employees"?"block":"hidden",children:e.jsx(he,{client:s,currentTheme:i,onViewAgent:Z})}),e.jsx("div",{className:d==="transactions"?"block":"hidden",children:e.jsx(xe,{client:s,currentTheme:i})})]})]})]})};export{Ne as default};
